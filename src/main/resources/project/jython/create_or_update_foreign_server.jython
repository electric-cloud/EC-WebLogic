#
#  Copyright 2016 Electric Cloud, Inc.
#
#  Licensed under the Apache License, Version 2.0 (the "License");
#  you may not use this file except in compliance with the License.
#  You may obtain a copy of the License at
#
#      http://www.apache.org/licenses/LICENSE-2.0
#
#  Unless required by applicable law or agreed to in writing, software
#  distributed under the License is distributed on an "AS IS" BASIS,
#  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
#  See the License for the specific language governing permissions and
#  limitations under the License.
#

[% preamble %]

# parameters section

username = r'''
[% username %]
'''.strip()

password = r'''
[% password %]
'''.strip()

admin_url = r'''
[% admin_url %]
'''.strip()

dt_name = r'''
[% cf_name %]
'''.strip()

jndi_name = r'''
[% jndi_name %]
'''.strip()

destination_type = r'''
[% destination_type %]
'''.strip()

forwarding_policy = r'''
[% forwarding_policy %]
'''.strip()

template = r'''
[% template %]
'''.strip()

jms_module_name = r'''
[% jms_module_name %]
'''.strip()

jms_server_name = r'''
[% jms_server_name %]
'''.strip()

server_name = r'''
[% server_name %]
'''.strip()

subdeployment_name = r'''
[% subdeployment_name %]
'''.strip()

def getDistributedTopicPath(jms_module_name,dt_name):
    return "%s/UniformDistributedTopics/%s"%(getJMSModulePath(jms_module_name),dt_name) 

def getDistributedTopic(jms_module_name,dt_name):
    return getMBean(getDistributedTopicPath(jms_module_name,dt_name))

def cdDistributedTopicPath(jms_module_name,dt_name):
    cd(getDistributedTopicPath(jms_module_name,dt_name))

connect(username, password, admin_url)

try:
    startChanges()
    cd('/')
    if not checkJMSModule(jms_module_name):
        warn("JMS Module %s does not exist" % (jms_module_name))
        createJMSModule(jms_module_name, jms_server_name, server_name)
    
    cdJMSModulePath(jms_module_name)

    mode = 'edit'

    if not getDistributedTopic(jms_module_name,dt_name):
        mode = 'create'
        print_debug('Working in CREATE mode')
        print_info('Trying to create Uniform Distributed Topic ' + dt_name)
        dq = create(dq_name, 'UniformDistributedTopic')
    else:
        print_debug('Working in UPDATE mode. Resource exists')
        updateJMSModule(jms_module_name, jms_server_name, server_name)



    # cd to created resource
    cdDistributedTopicPath(jms_module_name,dt_name)
    if jndi_name:
        print_debug("Applying JNDI "+jndi_name)
        set('JNDIName', jndi_name)
        
    else:
        #usually JNDI should be defined to work with connection factory from app via JMS module
        warn("You did not define JNDI")

    #destination_type, forwarding_policy, template management research


    if subdeployment_name:
        if not checkSubDeployment(jms_module_name, subdeployment_name):
            print_info("SubDeployment %s does not exist in JMS Module %s"%(subdeployment_name, jms_module_name))
            createSubDeployment(jms_module_name, subdeployment_name)
            print_info("SubDeployment %s was created in JMS Module %s"%(subdeployment_name, jms_module_name))
            cdDistributedTopicPath(jms_module_name,dq_name)
        set('SubDeploymentName', subdeployment_name)
        cdSubDeploymentPath(jms_module_name, subdeployment_name)
        if jms_server_name and checkJMSServer(jms_server_name):
            print_info("Adding target %s to SubDeployment %s"%(jms_server_name,subdeployment_name))
            targets = []
            for t in get('Targets'):
                targets.append(t)
            targets.append(getJMSServer(jms_server_name).objectName)
            set('Targets', jarray.array(targets, ObjectName))
        elif jms_server_name and not checkJMSServer(jms_server_name):
            warn("JMS Server %s does not exist. It was not added to Connection Factory"%(jms_server_name))


except WLSTException, e:
    print "Failed to create Distributed Queue"
    print str(e)
    discardChanges()
    sys.exit(1)

# everyghing is fine, commiting
commitChanges()